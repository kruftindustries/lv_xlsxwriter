================================================================================
 Windows Sandbox Development Environment Setup
================================================================================

This folder contains files to automate setting up a development environment
in Windows Sandbox with Visual Studio Community 2026 and LabVIEW.

FILES:
------
  install_dev_environment.wsb  - Windows Sandbox configuration file
  shared\                      - Folder mapped to sandbox desktop as "Setup"
    install_all.bat            - Main installation script (runs automatically)
    LabVIEW.iso                - [YOU MUST ADD THIS] LabVIEW installation ISO
    specfile_lv\               - LabVIEW specfile folder (mapped to Desktop\specfile)
      nisuite.xml              - LabVIEW installation specification

PREREQUISITES:
--------------
  1. Windows 10/11 Pro, Enterprise, or Education
  2. Windows Sandbox feature enabled:
     - Open "Turn Windows features on or off"
     - Check "Windows Sandbox"
     - Restart if prompted

SETUP INSTRUCTIONS:
-------------------
  1. Copy your LabVIEW installation ISO to:
     C:\Users\Nick\Desktop\xlsxwriter-dev\sandbox\shared\LabVIEW.iso

  2. (Optional) Edit labview_config.ini to customize LabVIEW installation options

  3. Double-click "install_dev_environment.wsb" to launch the sandbox

  4. The installation will start automatically and install:
     - Visual Studio Community 2026 with:
       * C++ Desktop Development workload
       * CMake tools
       * Windows 11 SDK
       * (Excludes GitHub Copilot components)
     - LabVIEW (if ISO is present)

  5. Installation takes approximately 20-40 minutes depending on internet speed

PERFORMANCE OPTIMIZATION:
-------------------------
The script automatically applies a Windows Sandbox performance workaround
that disables Code Integrity policy verification. This significantly speeds
up installer execution in the sandbox environment. The commands run are:

  Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\CI\Policy" ^
      -Name "VerifiedAndReputablePolicyState" -Value 0
  CiTool.exe -r

This is safe within the sandbox as all changes are discarded when closed.

BUILDING LIBXLSXWRITER:
-----------------------
After installation completes, run the build script:
  C:\Users\WDAGUtilityAccount\Desktop\Setup\build.bat

This script will:
  1. Clone zlib from GitHub
  2. Build zlib 32-bit (static library)
  3. Build libxlsxwriter 32-bit (DLL)
  4. Build zlib 64-bit (static library)
  5. Build libxlsxwriter 64-bit (DLL)

Output files will be in:
  32-bit: Setup\libxlsxwriter-1.2.3\build32\Release\xlsxwriter.dll
  64-bit: Setup\libxlsxwriter-1.2.3\build64\Release\xlsxwriter.dll

WHAT GETS INSTALLED:
--------------------
Visual Studio Community Edition:
  - Microsoft.VisualStudio.Workload.NativeDesktop (C++ Desktop Development)
  - Microsoft.VisualStudio.Component.VC.Tools.x86.x64 (MSVC Compiler)
  - Microsoft.VisualStudio.Component.Windows11SDK.22621 (Windows SDK)
  - Microsoft.VisualStudio.Component.VC.CMake.Project (CMake Tools)

EXCLUDED from Visual Studio:
  - Component.GitHub.Copilot
  - Component.GitHub.Copilot.Chat
  - Microsoft.VisualStudio.Component.VC.Llvm.Clang

LabVIEW:
  - Configured via specfile (nisuite.xml)
  - Command: setup /applyspecfile <path> /q /acceptlicenses yes /r:n /disableNotificationCheck
  - Silent installation with license acceptance

LOG FILES:
----------
Installation logs are saved to:
  C:\Users\WDAGUtilityAccount\Desktop\Setup\logs\

CUSTOMIZATION:
--------------
To modify Visual Studio components, edit install_all.bat and change the
--add or --remove parameters. Full list of component IDs available at:
https://docs.microsoft.com/en-us/visualstudio/install/workload-component-id-vs-community

To modify LabVIEW installation options, edit specfile_lv\nisuite.xml.
This file is generated by NI Package Manager's "Create Spec File" feature.

NOTES:
------
- Windows Sandbox is a temporary environment. All changes are lost when closed.
- The sandbox has network access to download Visual Studio.
- The shared folder is writable, so you can copy build artifacts back.
- Sandbox uses ~8GB RAM (configurable in .wsb file).
- After installation, a command prompt remains open for testing.

JENKINS INTEGRATION:
--------------------
Two options for Jenkins builds:

1. Pipeline Job (Jenkinsfile):
   - Create a new Pipeline job in Jenkins
   - Point to the repository containing sandbox/Jenkinsfile
   - Parameters: VERSION (default 1.2.4), CLEAN_WORKSPACE (default false)
   - Requires Windows agent with Sandbox enabled

2. Freestyle Job (jenkins_build.bat):
   - Create a new Freestyle job
   - Add "Execute Windows batch command" build step:
       call C:\path\to\sandbox\jenkins_build.bat
   - Add "Archive the artifacts" post-build action:
       sandbox/shared/output/*.zip

Requirements for Jenkins Windows Agent:
   - Windows 10/11 Pro, Enterprise, or Education
   - Windows Sandbox feature enabled
   - Agent must run as a user (not SYSTEM) with GUI access
   - Recommended: Run agent via JNLP with "Launch agent by connecting it to the controller"

The build process:
   1. Creates AUTO_BUILD flag file
   2. Launches Windows Sandbox with install_dev_environment.wsb
   3. Sandbox installs VS 2026, builds libxlsxwriter
   4. Sandbox creates BUILD_COMPLETE flag when done
   5. Jenkins detects completion and archives output zips

Timeout: 90 minutes (configurable in scripts)

TROUBLESHOOTING:
----------------
1. "Windows Sandbox failed to start"
   - Ensure virtualization is enabled in BIOS
   - Ensure Hyper-V is not disabled by group policy

2. Visual Studio installation fails
   - Check logs at shared\logs\vs_install.log
   - Ensure stable internet connection

3. LabVIEW ISO not mounting
   - Verify the ISO file is not corrupted
   - Try mounting manually: Right-click ISO > Mount

4. Slow installation
   - The performance optimization should help significantly
   - If still slow, check Task Manager for disk/CPU bottlenecks
================================================================================
